var wpNotesCommon;var wpNotesCommentModView;var wpNoteList;var wpNoteModel;(function(e){var t=document.cookie.split(/;\s*/),n=false;for(i=0;i<t.length;i++){if(t[i].match(/^wp_api=/)){t=t[i].split("=");n=t[1];break}}wpNotesCommon={jsonAPIbase:"https://public-api.wordpress.com/rest/v1",hasUpgradedProxy:false,noteTypes:{comment:"comment",follow:"follow",like:["like","like_trap"],reblog:"reblog",trophy:["best_liked_day_feat","like_milestone_achievement","achieve_automattician_note","achieve_user_anniversary","best_followed_day_feat","followed_milestone_achievement"],"alert":["expired_domain_alert"]},noteType2Noticon:{"like":"like","follow":"follow","comment_like":"like","comment":"comment","comment_pingback":"external","reblog":"reblog","like_milestone_achievement":"trophy","achieve_followed_milestone_note":"trophy","achieve_user_anniversary":"trophy","best_liked_day_feat":"milestone","best_followed_day_feat":"milestone","automattician_achievement":"trophy","expired_domain_alert":"alert","automattcher":"atsign"},createNoteContainer:function(t,n){var o=e("<div/>",{id:n+"-note-"+t.id,"class":"wpn-note wpn-"+t.type+" "+(t.unread>0?"wpn-unread":"wpn-read")}).data({id:parseInt(t.id,10),type:t.type});var a=e("<div/>",{"class":"wpn-note-body wpn-note-body-empty"});var r=e("<div/>",{style:"position: absolute; left: 180px; top: 60px;"});a.append(r);r.spin("medium");o.append(this.createNoteSubject(t),a);return o},createNoteSubject:function(t){var n=e("<div/>",{"class":"wpn-note-summary"}).append(e("<span/>",{"class":"wpn-noticon noticon noticon"+t.noticon}),e("<span/>",{"class":"wpn-icon no-grav",html:e("<img/>",{src:t.subject.icon,width:"24px",height:"24px",style:"display: inline-block; width: 24px; height: 24px; overflow-x: hidden; overflow-y: hidden;"})}),e("<span/>",{"class":"wpn-subject",html:t.subject.html}));return n},createNoteBody:function(t){var n=e("<div/>",{"class":"wpn-note-body"});var o=t.toJSON();var a="wpn-"+o.body.template;switch(o.body.template){case"single-line-list":case"multi-line-list":n.append(e("<p/>").addClass(a+"-header").html(o.body.header));for(var r in o.body.items){var s=e("<div></div>",{"class":a+"-item "+a+"-item-"+r+(o.body.items[r].icon?"":" "+a+"-item-no-icon")});if(o.body.items[r].icon){s.append(e("<img/>",{"class":a+"-item-icon avatar avatar-"+o.body.items[r].icon_width,height:o.body.items[r].icon_height,width:o.body.items[r].icon_width,src:o.body.items[r].icon}))}if(o.body.items[r].header){s.append(e("<div></div>",{"class":a+"-item-header"}).html(o.body.items[r].header))}if(o.body.items[r].action){switch(o.body.items[r].action.type){case"follow":var m=wpFollowButton.create(o.body.items[r].action);s.append(m);m.click(function(t){if(e(this).children("a").hasClass("wpcom-follow-rest"))wpNotesCommon.bumpStat("notes-click-action","unfollow");else wpNotesCommon.bumpStat("notes-click-action","follow");return true});break;default:console.error("Unsupported "+o.type+" action: "+o.body.items[r].action.type);break}}if(o.body.items[r].html){s.append(e("<div></div>",{"class":a+"-item-body"}).html(o.body.items[r].html))}n.append(s)}if(o.body.actions){var c=new wpNotesCommentModView({model:t});c.render();n.append(c.el)}if(o.body.footer){n.append(e("<p/>").addClass(a+"-footer").html(o.body.footer))}break;case"big-badge":if(o.body.header){n.append(e("<div/>").addClass(a+"-header").html(o.body.header))}if(o.body.badge){n.append(e("<div></div>",{"class":a+"-badge "}).append(o.body.badge))}if(o.body.html!==""){n.append(e("<div/>").addClass(a+"-footer").html(o.body.html))}break;default:n.text("Unsupported note body template!");break}n.find("a[notes-data-click]").mousedown(function(t){var n=e(this).attr("notes-data-click");wpNotesCommon.bumpStat("notes-click-body",n);return true});return n},getNoteSubjects:function(e,t,n){e.fields="id,type,unread,noticon,timestamp,subject";e.trap=true;return this.getNotes(e,t,n)},getNotes:function(e,t,n){return this.ajax({type:"GET",path:"/notifications/",data:e,success:t,error:n})},getMentions:function(e,t){return this.ajax({type:"GET",path:"/users/suggest",data:e,success:t})},markNotesSeen:function(e){return this.ajax({type:"POST",path:"/notifications/seen",data:{time:e}})},markNotesRead:function(t){var n={};var o=this;for(var a in t){if(t[a]>0){n["counts["+a+"]"]=t[a]}}if(0===n.length){return new e.Deferred().resolve("no unread notes")}return this.ajax({type:"POST",path:"/notifications/read",data:n,success:function(e){},error:function(e){}})},ajax:function(t){var n=this;var o={path:t.path,method:t.type};if(t.type.toLowerCase()=="post")o.body=t.data;else o.query=t.data;return e.Deferred(function(a){var r=function(){e.wpcom_proxy_request(o,function(e,n){if(200==n){if("function"==typeof t.success){t.success(e)}return a.resolve(e)}if("function"==typeof t.error){t.error(n)}else{console.error(n)}return a.reject(n)})};if(n.hasUpgradedProxy){return r()}return e.wpcom_proxy_request({metaAPI:{accessAllUsersBlogs:true}}).done(function(){n.hasUpgradedProxy=true;r()})})},bumpStat:function(e,t){if("undefined"!=typeof wpNotesIsJetpackClient&&wpNotesIsJetpackClient){var n=["notes-menu-impressions","notes-menu-clicks"];if(_.contains(n,e)){t=t.replace(/(,|$)/g,"-jetpack$1")}}new Image().src=document.location.protocol+"//pixel.wp.com/g.gif?v=wpcom-no-pv&x_"+e+"="+t+"&baba="+Math.random()},getKeycode:function(e){e=e||window.event;if(e.target)element=e.target;else if(e.srcElement)element=e.srcElement;if(element.nodeType==3)element=element.parentNode;if(e.ctrlKey===true||e.altKey===true||e.metaKey===true)return false;var t=e.keyCode?e.keyCode:e.which;if(t&&(element.tagName=="INPUT"||element.tagName=="TEXTAREA"||element.tagName=="SELECT"))return false;if(t&&element.contentEditable=="true")return false;return t}};wpNoteModel=Backbone.Model.extend({defaults:{summary:"",unread:true},_reloadBlocked:false,initialize:function(){},markRead:function(){var e=this.get("unread");if(Boolean(parseInt(e,10))){var t={};t[this.id]=e;wpNotesCommon.markNotesRead(t);wpNotesCommon.bumpStat("notes-read-type",this.get("type"))}},loadBody:function(){wpNotesCommon.createNoteBody(this)},reload:function(){var t=this;var n="id,type,unread,noticon,subject,body,date,timestamp,status";if("comment"==t.get("type")){n+=",approval_status,has_replied"}if(!force&&this.isReloadingBlocked()){return e.Deferred().reject("reloading blocked")}return wpNotesCommon.getNotes({fields:n,trap:true,ids:[t.get("id")]},function(e){var n=e.notes;if(typeof n[0]!=="undefined"){t.set(n[0])}},function(){})},resize:function(){this.trigger("resize")},blockReloading:function(e){var t=this;this._reloadBlocked=true;clearTimeout(this.reloadBlockerTimeout);return this.reloadBlockerTimeout=setTimeout(function(){return t._reloadBlocked=false},e*1e3)},isReloadingBlocked:function(){return this._reloadBlocked}});wpNoteList=Backbone.Collection.extend({model:wpNoteModel,lastMarkedSeenTimestamp:false,newNotes:false,maxNotes:false,loading:false,hasLoaded:false,allBodiesLoaded:false,comparator:function(e){return-e.get("timestamp")},addNotes:function(e){e=_.filter(e,function(e){return typeof e.subject==="object"});var t=_.map(e,function(e){return new wpNoteModel(e)});this.add(t);this.sort();if(this.maxNotes){while(this.length>this.maxNotes){this.pop()}}this.trigger("loadNotes:change")},getMostRecentTimestamp:function(){if(!this.length){return false}this.sort();return parseInt(this.at(0).get("timestamp"),10)},loadNotes:function(e){var t=this;t.loading=true;t.trigger("loadNotes:beginLoading");var n=e.fields;var o=parseInt(e.number,10);var a=parseInt(e.before,10);var r=parseInt(e.since,10);var s=parseInt(e.timeout,10)||7e3;var m="undefined"==typeof e.type?null:e.type;var c="undefined"==typeof e.unread?null:e.unread;e={timeout:s};if(!n){n="id,type,unread,noticon,subject,body,date,timestamp,status"}if(isNaN(o)){o=9}if(!isNaN(a)){e.before=a}if(!isNaN(r)){e.since=r}if(c!==null){e.unread=c}if(m!==null&&m!="unread"&&m!="latest"){e.type=m}e.number=o;e.fields=n;e.trap=true;return wpNotesCommon.getNotes(e).done(function(e){var n;var o=e.notes;var a=false;if(!t.lastMarkedSeenTimestamp||e.last_seen_time>t.lastMarkedSeenTimestamp){a=true;t.lastMarkedSeenTimestamp=parseInt(e.last_seen_time,10)}for(var r in o){var s=t.get(o[r].id);if(s){if(typeof o[r].subject!="object"){t.remove(o[r].id);a=true;continue}if(m){n=s.get("queried_types")||{};n[m]=true;o[r].queried_types=n}s.set(o[r])}else{if(typeof o[r].subject!="object"){continue}if(m){n={};n[m]=true;o[r].queried_types=n}s=new wpNoteModel(o[r]);t.add(s)}if(!s.has("body"))t.allBodiesLoaded=false;a=true}if(t.maxNotes){while(t.length>t.maxNotes){t.pop()}}if(a){t.sort();t.trigger("loadNotes:change")}t.loading=false;t.hasLoaded=true;t.trigger("loadNotes:endLoading")}).fail(function(e){t.loading=false;t.trigger("loadNotes:failed")})},loadNoteBodies:function(t){var n=this;if(n.allBodiesLoaded){return new e.Deferred().resolve()}var o=n.getNoteIds(t);if(0==o.length){return new e.Deferred().reject()}var a=function(e){var t=e.notes;for(var o in t){if(typeof t[o].subject!="object"){continue}var a=n.get(t[o].id);if(a){a.set(t[o])}else{a=new wpNoteModel(t[o]);n.add(a)}}};var r=function(e){if(typeof console!="undefined"&&typeof console.error=="function")console.error("body loading error!")};var s=[];var m=3;for(var c=0;c<m;c++){if(typeof o[c]=="undefined")break;var l={};l.fields="id,type,unread,noticon,timestamp,subject,body,meta,status";l.trap=true;l["ids["+c+"]"]=o[c];s.push(wpNotesCommon.getNotes(l).done(a).fail(r))}if(o.length>m){var l={};l.fields="id,type,unread,noticon,timestamp,subject,body,meta,status";l.trap=true;for(var c=m;c<o.length;c++)l["ids["+c+"]"]=o[c];s.push(wpNotesCommon.getNotes(l).done(a).fail(r))}var p=e.when.apply(null,s);p.done(function(){if(typeof t!="function"){n.allBodiesLoaded=true}});return p},markNotesSeen:function(){var e=this,t=e.getMostRecentTimestamp();if(t>this.lastMarkedSeenTimestamp){wpNotesCommon.markNotesSeen(t).done(function(){e.lastMarkedSeenTimestamp=false})}},unreadCount:function(){return this.reduce(function(e,t){return e+(t.get("unread")?1:0)},0)},numberNewNotes:function(){var e=this;if(!e.lastMarkedSeenTimestamp)return 0;return e.getNewNotes().length},getNewNotes:function(){var e=this;return e.filter(function(t){return t.get("timestamp")>e.lastMarkedSeenTimestamp})},getUnreadNotes:function(){return this.filter(function(e){return Boolean(parseInt(e.get("unread"),10))})},getNotesOfType:function(e){var t=this;switch(e){case"unread":return t.getUnreadNotes();case"latest":return t.filter(function(e){var t=e.get("queried_types");return"undefined"!=typeof t&&"undefined"!=typeof t.latest&&t.latest});default:return t.filter(function(t){var n=t.get("type");if("undefined"==typeof wpNotesCommon.noteTypes[e]){return false}else if("string"==typeof wpNotesCommon.noteTypes[e]){return e==n}var o=wpNotesCommon.noteTypes[e].length;for(var a=0;a<o;a++){if(wpNotesCommon.noteTypes[e][a]==n){return true}}return false})}},getNoteIds:function(e){if(typeof e!="function")e=function(){return true};return _.pluck(this.filter(e),"id")}});wpNotesCommentModView=Backbone.View.extend({mode:"buttons",actionsByName:null,possibleActions:["approve-comment","replyto-comment","like-comment","spam-comment","trash-comment","unapprove-comment","unlike-comment","unspam-comment","untrash-comment"],possibleStatuses:["approved","spam","trash","unapproved"],events:{"click .wpn-replyto-comment-button-open a":"openReply","click .wpn-comment-reply-button-close":"closeReply","click .wpn-comment-reply-button-send":"sendReply","click .wpn-like-comment-button a":"clickLikeComment","click .wpn-unlike-comment-button a":"clickLikeComment","click .wpn-approve-comment-button a":"clickModComment","click .wpn-unapprove-comment-button a":"clickModComment","click .wpn-spam-comment-button a":"clickModComment","click .wpn-unspam-comment-button a":"clickModComment","click .wpn-trash-comment-button a":"clickModComment","click .wpn-untrash-comment-button a":"clickModComment"},templateActions:'			{{#reply}}			<span class="{{reply.class}}">				<a href="#" title="{{reply.title}}" data-action-type="{{reply.actionType}}">{{reply.text}}</a>			</span>			{{/reply}}			{{#like}}			<span class="{{like.class}}">				<a href="#" title="{{like.title}}" data-action-type="{{like.actionType}}">{{like.text}}</a>			</span>			{{/like}}			<span class="wpn-more">				<a href="#">More</a>				<div class="wpn-more-container">				{{#spam}}				<span class="{{spam.class}}">					<a href="#" title="{{spam.title}}" data-action-type="{{spam.actionType}}">{{spam.text}}</a>				</span>				{{/spam}}				{{#trash}}				<span class="{{trash.class}}">					<a href="#" title="{{trash.title}}" data-action-type="{{trash.actionType}}">{{trash.text}}</a>				</span>				{{/trash}}				</div>			</span>			{{#approve}}			<span class="{{approve.class}}">				<a href="#" title="{{approve.title}}" data-action-type="{{approve.actionType}}">{{approve.text}}</a>			</span>			{{/approve}}			<span class="wpn-comment-mod-waiting"></span>',templateReply:'			<div class="wpn-note-comment-reply">				<h5>{{reply_header_text}}</h5>				<textarea class="wpn-note-comment-reply-text" rows="5" cols="45" name="wpn-note-comment-reply-text"></textarea>				<p class="wpn-comment-submit">					<span class="wpn-comment-submit-waiting" style="display: none;"></span>				<span class="wpn-comment-submit-error" style="display:none;">Error!</span>				<a href="#" class="wpn-comment-reply-button-send alignright">{{submit_button_text}}</a>				<a href="#" class="wpn-comment-reply-button-close alignleft">_</a>				</p>			</div>',initialize:function(){var t=this;this.setElement(e('<div class="wpn-note-comment-actions" />'));this.listenTo(this.model,"change:status",function(e,n){var o,a;o=n.approval_status;a=e.previous("status")||{};if(a.approval_status&&a.approval_status===o){return}if(o.match(/^trash|spam$/)){return t.setUndoStatus(a.approval_status)}});this.listenTo(this.model,"change",this.render);e(document).on("click",".wpn-more > a",function(t){var n;t.preventDefault();t.stopPropagation();if(t.doneMoreToggle){return}t.doneMoreToggle=true;n=e(t.currentTarget);n.parent().find(".wpn-more-container").toggle();return false});this;e(document).on("click",".wpn-note-body",function(t){var n,o;n=e(t.target);if(n.parents(".wpn-more").length){return}o=n.closest(".wpn-note-body");if(o.find(".wpn-more-container").is(":visible")){o.find(".wpn-more-container").toggle()}});this;e(".wpn-more-container:not(:has(*))").parents(".wpn-more").hide();e(document).on("keydown",function(e){var n,o,a;if(t.$el.is(":hidden")){return}if(t.mode!=="buttons"){return}n=wpNotesCommon.getKeycode(e);if(!n){return}a=t.getValidActions();o=t.model.get("status")||{};if(n===82){if(_.contains(a,"replyto-comment")){t.openReply(e)}}if(n===65){if(_.contains(a,"approve-comment")){t.modComment("approve-comment")}else if(_.contains(a,"unapprove-comment")){t.modComment("unapprove-comment")}}if(n===76){if(_.contains(a,"like-comment")){t.likeComment("like-comment")}else if(_.contains(a,"unlike-comment")){t.likeComment("unlike-comment")}}if(n===83){if(_.contains(a,"spam-comment")){t.modComment("spam-comment")}else if(_.contains(a,"unspam-comment")){t.modComment("unspam-comment")}}if(n===84){if(_.contains(a,"trash-comment")){t.modComment("trash-comment")}else if(_.contains(a,"untrash-comment")){t.modComment("untrash-comment")}}return false});return this},render:function(){var e;if(this.model._changing&&"reply"===this.mode){return this}this.$el.empty();e=this.model.get("body");if(!e.actions){return this}this.updateActionsMap();if(this.mode==="buttons"){this.$el.html(this.createActionsHTML())}else{this.$el.html(this.createReplyBoxHTML());this.$("textarea").focus()}this.delegateEvents();return this},setUndoStatus:function(e){return this._undoStatus=e},getUndoStatus:function(){var e;if(this._undoStatus){return this._undoStatus}e=this.model.get("status");if(e!=null&&e.undo_status==="1"){return"approved"}return"unapproved"},getValidActions:function(){var e,t;t=this.model.get("status")||{};switch(t.approval_status){case"pending":case"unapproved":return["replyto-comment","approve-comment","spam-comment","trash-comment"];case"approved":e=["replyto-comment","unapprove-comment","spam-comment","trash-comment"];if(t.i_liked){e.splice(1,0,"unlike-comment")}else{e.splice(1,0,"like-comment")}return e;case"trash":return["untrash-comment"];case"spam":return["unspam-comment"];default:return[]}},getResultantStatus:function(e){switch(e){case"approve-comment":return"approved";case"unapprove-comment":return"unapproved";case"spam-comment":return"spam";case"trash-comment":return"trash";case"unspam-comment":case"untrash-comment":return this.getUndoStatus();default:return void 0}},getStatusParamFromActionType:function(e){if(!e){return void 0}switch(e){case"approve-comment":return"approved";case"unapprove-comment":return"unapproved";default:return e.split("-")[0]}},getComplementaryActionType:function(e){switch(e){case"approve-comment":return"unapprove-comment";case"unapprove-comment":return"approve-comment";case"like-comment":return"unlike-comment";case"unlike-comment":return"like-comment";case"spam-comment":return"unspam-comment";case"trash-comment":return"untrash-comment";case"unspam-comment":return"spam-comment";case"untrash-comment":return"trash-comment";default:return void 0}},getTranslation:function(e){if(typeof notes_i18n==="undefined"||!notes_i18n.translate){return e}return notes_i18n.translate(e).fetch()},getTranslationsForActionType:function(e){var t;t=this.getTranslation;if(!this._translationsByActionType){this._translationsByActionType={"approve-comment":{buttonText:t("Approve"),titleText:t("Approve this comment.")},"like-comment":{buttonText:t("Like"),titleText:t("Like this comment.")},"replyto-comment":{buttonText:t("Reply"),titleText:t("Reply to this comment.")},"spam-comment":{buttonText:t("Spam"),titleText:t("Mark this comment as spam.")},"trash-comment":{buttonText:t("Trash"),titleText:t("Move this comment to the trash.")},"unapprove-comment":{buttonText:t("Unapprove"),titleText:t("Unapprove this comment.")},"unlike-comment":{buttonText:t("Liked"),titleText:t("Unlike this comment.")},"unspam-comment":{buttonText:t("Unspam"),titleText:t("Unmark this comment as spam.")},"untrash-comment":{buttonText:t("Untrash"),titleText:t("Restore this comment from the trash.")}}}return this._translationsByActionType[e]},updateActionsMap:function(){var t,n,o,a,r,s,m,c,l,p,u,d=this;a=this.model.get("body");o=a.actions||[];this.actionsByName=this.actionsByName||{};r=function(t){if(!t.type||!t.params){return}return d.actionsByName[t.type]=e.extend({},t.params,{actionType:t.type})};for(s=0,c=o.length;s<c;s++){t=o[s];r(t)}p=this.possibleActions;u=[];for(m=0,l=p.length;m<l;m++){n=p[m];u.push(function(t){var n,o,a,r,s,m;n=d.actionsByName[t];r=d.getStatusParamFromActionType(t);m=d.getTranslationsForActionType(t);if(!n){o=d.actionsByName[d.getComplementaryActionType(t)];if(o){d.actionsByName[t]=e.extend({},o,{actionType:t,ajax_arg:r,rest_body:{status:r},text:m.buttonText,title_text:m.titleText})}}if(t==="replyto-comment"){a=d.model.get("status"||{});s=a.approval_status==="approved"?d.getTranslation("Reply"):d.getTranslation("Approve and Reply");return e.extend(d.actionsByName["replyto-comment"],{button_text:m.buttonText,submit_button_text:s,text:m.buttonText,title_text:m.titleText})}}(n))}return u},createActionsHTML:function(){var t,n,o,a,r,s,m,c=this;n=this.model.get("status").approval_status;o={};m=this.getValidActions();a=function(t){var a,r;a=c.actionsByName[t];if(!a){return}r={"class":"wpn-"+t+"-button","actionType":t,"text":a.text||a.button_text};switch(t){case"replyto-comment":return o.reply=e.extend({},r,{"class":"wpn-replyto-comment-button-open","title":(a.title_text||a.button_title_text)+" [r]"});case"like-comment":case"unlike-comment":return o.like=e.extend({},r,{"title":(a.title_text||a.button_title_text)+" [l]"});case"approve-comment":case"unapprove-comment":if(_.contains(["spam","trash"],n)){break}return o.approve=e.extend({},r,{"title":(a.title_text||a.button_title_text)+" [a]"});case"spam-comment":case"unspam-comment":if(n==="trash"){break}return o.spam=e.extend({},r,{"title":(a.title_text||a.button_title_text)+" [s]"});case"trash-comment":case"untrash-comment":if(n==="spam"){break}return o.trash=e.extend({},r,{"title":(a.title_text||a.button_title_text)+" [t]"})}};for(r=0,s=m.length;r<s;r++){t=m[r];a(t)}return Mustache.render(this.templateActions,o)},createReplyBoxHTML:function(){var e,t,n;e=this.actionsByName["replyto-comment"];if(!e){return}t=e.site_id||0;n=this.model.id||0;return Mustache.render(this.templateReply,{reply_header_text:e.reply_header_text,submit_button_text:e.submit_button_text})},closeReply:function(e){if(e){e.preventDefault()}this.mode="buttons";this.model.currentReplyText=this.$el.children(".wpn-note-comment-reply").children(".wpn-note-comment-reply-text").val();this.render();return this.model.resize()},openReply:function(t){var n,o,a,r=this;if(t){t.preventDefault()}this.mode="reply";this.render();this.$el.children(".wpn-note-comment-reply").children(".wpn-note-comment-reply-text").val(this.model.currentReplyText);e(".selected .wpn-note-body p.submitconfirm").remove();this.model.resize();if(!window.mentionDataCache){window.mentionDataCache=[]}n=this.actionsByName["replyto-comment"];if(n.site_id!=null){if(window.mentionDataCache[n.site_id]!=null){return this.$el.children(".wpn-note-comment-reply").children(".wpn-note-comment-reply-text").mentions(window.mentionDataCache[n.site_id])}else{window.mentionDataCache[n.site_id]=[];a={site_id:n.site_id,client:"notes-widget"};o=wpNotesCommon.getMentions(a);return o.done(function(e){window.mentionDataCache[n.site_id]=e.suggestions;return r.$el.children(".wpn-note-comment-reply").children(".wpn-note-comment-reply-text").mentions(window.mentionDataCache[n.site_id])})}}},sendReply:function(t){var n,o,a,r,s,m,c,l=this;if(t){t.preventDefault()}o=this.actionsByName["replyto-comment"];if(!o){return e.Deferred().reject("Invalid replyto-comment action")}s=this.$el.children(".wpn-note-comment-reply");this.model.currentReplyText=s.children(".wpn-note-comment-reply-text").val();a=o.site_id||0;r=o.comment_id||0;m=this.model.currentReplyText||0;if(!(a&&r&&m)){return e.Deferred().reject("Invalid sendReply params")}n=s.children(".wpn-comment-submit");n.children(".wpn-comment-submit-error").hide();n.children(".wpn-comment-reply-button-send").hide();n.children(".wpn-comment-submit-waiting").gifspin("small").show();wpNotesCommon.bumpStat("notes-click-action","replyto-comment");c=function(){return wpNotesCommon.ajax({type:"POST",path:"/sites/"+a+"/comments/"+r+"/replies/new",data:{content:m},success:function(e){if(typeof e==="string"){l.errorReply(e);return false}l.closeReply();l.model.currentReplyText="";return l.model.reload(true).done(function(){var e;if(!l.model.get("status").i_replied){e=0;return l.replyCommentInterval=setInterval(function(){return l.model.reload(true).done(function(){if(l.model.get("status").i_replied||e++>=10){return clearInterval(l.replyCommentInterval)}})},3e3)}})},error:function(e){return l.errorReply(e)}}).done(function(){var t,n;t=e(".selected .wpn-comment-date a").attr("href");n='<p class="submitconfirm"><strong>';n+=notes_i18n.translate("Reply successful, <a %s>view thread</a>").fetch('target="_blank" href="'+t+'"');n+="</strong></p>";return e(".selected .wpn-note-body").append(n)})};if(this.model.get("status").approval_status!=="approved"){return this.modComment("approve-comment").done(c)}else{return c()}},errorReply:function(t){var n,o,a;o=t;if(typeof t==="object"){if(t.responseText){a=e.parseJSON(t.responseText);o=a.error+": "+a.message}else if(t.statusText){o=t.statusText}else{o="Unknown Error"}}n=this.$el.children(".wpn-note-comment-reply");n.children(".wpn-comment-submit").children(".wpn-comment-submit-waiting").hide();if(o){return n.children(".wpn-comment-submit").children(".wpn-comment-submit-error").text(o).show()}},clickModComment:function(t){if(t){t.preventDefault()}else{return e.Deferred.reject("invalid click event")}return this.modComment(e(t.currentTarget).data("action-type"))},modComment:function(t){var n,o=this;this.$(".wpn-comment-mod-waiting").show().gifspin("small");n=e.Deferred().always(function(){return o.$(".wpn-comment-mod-waiting").empty().hide()}).fail(function(e,t){if(typeof console!=="undefined"&&console!==null&&typeof console.error==="function"){console.error("Comment moderation error");if(e){console.error(e)}}if(!t||t!=="too_soon"){return o.model.reload()}});if(this.modPromise&&typeof this.modPromise.state==="function"&&this.modPromise.state()==="pending"){n.always(function(){return o.$(".wpn-comment-mod-waiting").show().gifspin("small")});return n.reject("Moderation already in progress","too_soon")}this.modPromise=n.promise();if(!t||!t.length||!_.contains(this.getValidActions(),t)){return n.reject("Invalid actionType")}e.Deferred(function(){var a,r;wpNotesCommon.bumpStat("notes-click-action",t);a=o.actionsByName[t];if(!a){return n.reject("Undefined action params for type: "+t)}r=o.getResultantStatus(t);if(r){o.model.set("status",e.extend({},o.model.get("status"),{approval_status:r}));o.$(".wpn-comment-mod-waiting").show().gifspin("small")}return wpNotesCommon.ajax({type:"POST",path:a.rest_path,data:a.rest_body}).done(function(t){var a;a=(t!=null?t.status:void 0)?t.status:"undefined";if(_.contains(o.possibleStatuses,a)){o.model.set("status",e.extend({},o.model.get("status"),{approval_status:a}));o.model.blockReloading(15);return n.resolve()}else{return n.reject('Invalid status: "'+a+'" received from moderation POST')}}).fail(function(e){return n.reject(e)})});return this.modPromise},clickLikeComment:function(t){var n,o;t.preventDefault();n=e(t.currentTarget);o=n.data("action-type");return this.likeComment(o)},likeComment:function(t){var n,o,a,r=this;n=this.actionsByName[t];if("like-comment"===t){o=true;a=n.rest_path+"new/"}else{o=false;a=n.rest_path+"mine/delete/"}this.model.set("status",e.extend({},this.model.get("status"),{i_liked:o}));this.$(".wpn-comment-mod-waiting").show().gifspin("small");return wpNotesCommon.ajax({type:"POST",path:a}).done(function(e){return r.$(".wpn-comment-mod-waiting").empty().hide()})}})})(jQuery);(function(){(function(e,t){return t.fn.gifspin=function(e){var n,o,a;n=t(this);if(_.isFinite(e)&&e>0){a=Math.min(~~e,128)}else{switch(e){case"tiny":a=8;break;case"small":a=16;break;case"medium":a=32;break;case"large":a=64;break;default:a=128}}o=t('<img class="gifspinner" src="//s0.wp.com/wp-content/mu-plugins/notes/images/loading.gif" />');o.css({height:a,width:a});n.html(o);return n}})(typeof exports!=="undefined"&&exports!==null?exports:this,window.jQuery)}).call(this);